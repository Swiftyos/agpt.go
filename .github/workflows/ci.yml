# Optimized CI Workflow
# Based on expert recommendations from Dave Farley & Martin Fowler's Continuous Delivery principles:
# - Fast feedback loops (target: 15-25 seconds)
# - Parallel execution to minimize wait time
# - Unit tests only (no external dependencies)
# - Race detection and E2E tests moved to nightly workflow
#
# See: https://martinfowler.com/bliki/ContinuousDelivery.html
# See: https://www.continuous-delivery.co.uk/

name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

# Cancel in-progress runs for the same branch
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Option 1: Single parallel job (fastest - recommended by experts)
  # Runs lint, build, and tests concurrently within one job
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.62.2

      - name: Run CI checks in parallel
        run: |
          set -e

          # Start lint in background
          echo "::group::Starting lint..."
          ($(go env GOPATH)/bin/golangci-lint run --timeout 60s 2>&1 | tee lint.log; echo $? > lint.exit) &
          LINT_PID=$!

          # Start build in background
          echo "::group::Starting build..."
          (go build -v ./... 2>&1 | tee build.log; echo $? > build.exit) &
          BUILD_PID=$!

          # Run unit tests (no race detector for speed - race detection in nightly)
          echo "::group::Running unit tests..."
          go test -v -timeout 30s -coverprofile=coverage.out ./... 2>&1 | tee test.log
          TEST_EXIT=$?

          # Wait for background jobs
          wait $LINT_PID || true
          wait $BUILD_PID || true

          # Collect results
          LINT_EXIT=$(cat lint.exit 2>/dev/null || echo 1)
          BUILD_EXIT=$(cat build.exit 2>/dev/null || echo 1)

          echo "::endgroup::"
          echo ""
          echo "=== CI Results ==="
          echo "Lint:  $([ "$LINT_EXIT" = "0" ] && echo '✅ PASSED' || echo '❌ FAILED')"
          echo "Build: $([ "$BUILD_EXIT" = "0" ] && echo '✅ PASSED' || echo '❌ FAILED')"
          echo "Test:  $([ "$TEST_EXIT" = "0" ] && echo '✅ PASSED' || echo '❌ FAILED')"
          echo ""

          # Report failures with details
          if [ "$LINT_EXIT" != "0" ]; then
            echo "::error::Lint failed"
            echo "::group::Lint output"
            cat lint.log
            echo "::endgroup::"
          fi

          if [ "$BUILD_EXIT" != "0" ]; then
            echo "::error::Build failed"
            echo "::group::Build output"
            cat build.log
            echo "::endgroup::"
          fi

          if [ "$TEST_EXIT" != "0" ]; then
            echo "::error::Tests failed"
          fi

          # Exit with failure if any check failed
          [ "$LINT_EXIT" = "0" ] && [ "$BUILD_EXIT" = "0" ] && [ "$TEST_EXIT" = "0" ]

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage.out
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}
